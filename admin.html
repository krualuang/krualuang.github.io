<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üõ†Ô∏è Admin Tool | ‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á - Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    :root{
        --bg:#0f1724; --card:#0b1220; --accent1:#ff7a59; --accent2:#ffd166; --accent3:#6ee7b7; --muted:#9aa4b2; --glass: rgba(255,255,255,0.04);
        --success:#2ecc71; --danger:#ff6b6b; --shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    *{box-sizing:border-box}
    body{font-family:'Prompt',sans-serif;margin:0;background:linear-gradient(180deg,#071126 0%, #071b2f 60%);color:#ecf0f6;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#022;box-shadow:var(--shadow);border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    header h1{margin:0;font-size:1.25rem}
    header .sub{opacity:0.9;font-weight:600}
    .wrap{max-width:1200px;margin:24px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h2{margin:0 0 10px 0;color:var(--accent2)}
    label{display:block;font-weight:600;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:8px}
    textarea{min-height:70px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}

    .btn-primary{background:linear-gradient(90deg,var(--accent1),#ff9a70);color:#04202a}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-success{background:var(--success);color:#04202a}

    .menu-list{margin-top:12px}
    .menu-item{display:flex;gap:14px;padding:12px;border-radius:10px;background:var(--glass);align-items:center;border:1px solid rgba(255,255,255,0.03)}
    .menu-item img{width:86px;height:66px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
    .menu-meta{flex:1}
    .menu-meta strong{display:block;color:var(--accent3);font-size:1.05rem}
    .small{color:var(--muted);font-size:0.9rem}

    .right-panel{position:sticky;top:24px}
    .preview{background:linear-gradient(180deg,#081126,#04203a);padding:12px;border-radius:10px}
    pre{white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;color:var(--accent3);overflow:auto}

    /* login modal style */
    .login-box{max-width:420px;margin:30px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg,#071126,#04203a);border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}

    .muted-note{color:var(--muted);font-size:0.9rem}
    .flex{display:flex;gap:10px;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);font-weight:700}

    footer{max-width:1200px;margin:20px auto;color:var(--muted);text-align:center;font-size:0.9rem}

    @media(max-width:980px){.grid{grid-template-columns:1fr}.right-panel{position:static;margin-top:16px}}
</style>
</head>
<body>
<header>
    <div>
        <h1>üõ†Ô∏è ‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á ‚Äî Admin Tool (Enhanced)</h1>
        <div class="sub">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π ‚Ä¢ ‡πÅ‡∏õ‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‚Ä¢ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel / translations.js</div>
    </div>
    <div class="flex">
        <div class="badge">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: Enhanced</div>
        <a href="#" onclick="window.location.reload()" style="text-decoration:none;margin-left:8px;color:#022;" class="btn-ghost btn-primary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</a>
    </div>
</header>

<div class="wrap">

    <!-- LOGIN / ADMIN PIN -->
    <div id="loginWrap" class="login-box card">
        <h2>‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
        <div style="margin-top:10px">
            <label>PIN (4 ‡∏´‡∏•‡∏±‡∏Å)</label>
            <input id="pin" type="text" placeholder="‡πÉ‡∏™‡πà PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå: 1234)">
            <div class="controls" style="margin-top:8px">
                <button id="btnLogin" class="btn-primary">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button id="btnUseDemo" class="btn-ghost">‡∏ó‡∏î‡∏•‡∏≠‡∏á (‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</button>
                <button id="btnChangePin" class="btn-ghost">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN</button>
            </div>
            <p class="muted-note">PIN ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (localStorage). ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á ‡πÉ‡∏´‡πâ‡∏ú‡∏™‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>
        </div>
    </div>

    <div id="adminUI" style="display:none">
        <div class="grid">
            <div>
                <!-- MAIN CARD: Add / Edit Menu -->
                <div class="card">
                    <h2>1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</h2>

                    <div class="row-form">
                        <label for="menuName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÑ‡∏ó‡∏¢)</label>
                        <input id="menuName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î">

                        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select id="menuCategory">
                            <option value="main">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</option>
                            <option value="app">‡∏Å‡∏±‡∏ö‡πÅ‡∏Å‡∏•‡πâ‡∏°</option>
                            <option value="dessert">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                            <option value="drink">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                        </select>

                        <label for="menuDesc">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                        <textarea id="menuDesc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏°‡∏ô‡∏π"></textarea>

                        <div style="display:flex;gap:12px">
                            <div style="flex:1">
                                <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                <input id="menuPrice" type="number" placeholder="120">
                            </div>
                            <div style="flex:1">
                                <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Optional)</label>
                                <input id="menuCode" type="text" placeholder="RM-01-XXX">
                            </div>
                        </div>

                        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="menuImageFile" type="file" accept="image/*">
                            <button id="btnRemoveImage" class="btn-ghost">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
                        </div>
                        <div id="imagePreview" style="margin-top:8px"></div>

                        <div class="controls" style="margin-top:10px">
                            <button id="addBtn" class="btn-success">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π</button>
                            <button id="clearBtn" class="btn-ghost">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                            <button id="saveLocal" class="btn-ghost">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button id="downloadJson" class="btn-ghost">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
                        </div>

                        <div style="margin-top:10px" class="muted-note">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô dataURL ‡πÉ‡∏ô localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ)</div>
                    </div>

                    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin:12px 0">

                    <h2>2. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î translations.js</h2>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div>
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÑ‡∏ó‡∏¢)</label>
                            <input id="menuNameTh" type="text" placeholder="‡∏ú‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏Å‡∏∏‡πâ‡∏á‡∏™‡∏î">
                        </div>
                        <div>
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label>
                            <input id="menuPriceTh" type="number" placeholder="120">
                        </div>
                    </div>
                    <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÑ‡∏ó‡∏¢)</label>
                    <textarea id="menuDescTh"></textarea>
                    <label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="lang" value="en" checked> EN</label>
                        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="lang" value="lo" checked> LO</label>
                        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="lang" value="zh-CN" checked> ZH</label>
                        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="lang" value="ja" checked> JA</label>
                        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="lang" value="vi" checked> VI</label>
                    </div>

                    <div class="controls">
                        <button id="generateMenuBtn" class="btn-primary">‚öôÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤</button>
                        <button id="downloadTranslations" class="btn-ghost">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î translations.js</button>
                        <button id="insertToTranslations" class="btn-ghost">üì• ‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ translations (local)</button>
                        <button id="copyJsonBtn" class="btn-ghost">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
                    </div>

                    <h3 style="margin-top:12px;color:var(--accent3)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON:</h3>
                    <pre id="generatedKeys"></pre>

                </div>

                <!-- IMPORT / EXPORT -->
                <div class="card" style="margin-top:16px">
                    <h2>3. Import / Export / Excel</h2>
                    <div class="controls">
                        <input id="fileIn" type="file" accept="application/json" style="display:none">
                        <button id="uploadJson" class="btn-ghost">‚¨ÜÔ∏è ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ menu.json</button>
                        <button id="downloadExcel" class="btn-primary">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
                        <button id="clearAll" class="btn-danger">üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div style="margin-top:10px" class="muted-note">Excel ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: name, desc, price, category, code, image(dataURL)</div>
                </div>

                <!-- MENU LIST -->
                <div class="card" style="margin-top:16px">
                    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <div id="menuListWrap" class="menu-list"></div>
                </div>

            </div>

            <!-- RIGHT PANEL: Preview / Translations / Settings -->
            <div class="right-panel">
                <div class="card preview">
                    <h2>Live Preview</h2>
                    <div id="menuPreview">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>

                <div class="card" style="margin-top:12px">
                    <h2>Translations (Local)</h2>
                    <div class="muted-note">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö translations ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå translations.js)</div>
                    <pre id="translationsDump">{}</pre>
                </div>

                <div class="card" style="margin-top:12px">
                    <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
                    <label>PIN ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label>
                    <input id="currentPin" readonly>
                    <label>‡∏ï‡∏±‡πâ‡∏á PIN ‡πÉ‡∏´‡∏°‡πà</label>
                    <div style="display:flex;gap:8px">
                        <input id="newPin" type="text" placeholder="PIN ‡πÉ‡∏´‡∏°‡πà 4 ‡∏´‡∏•‡∏±‡∏Å">
                        <button id="savePinBtn" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                    <div style="margin-top:8px" class="muted-note">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô localStorage key: <code>krualuang_admin_pin</code></div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Assistant ‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</footer>

<script>
// ================= CONFIG =================
const STORAGE_KEY = 'krualuang_menu_v2';
const PIN_KEY = 'krualuang_admin_pin';
const TRANSLATIONS_KEY = 'krualuang_translations_v1';
// default pin
if(!localStorage.getItem(PIN_KEY)) localStorage.setItem(PIN_KEY, '1234');

// translations object in-memory
let translations = JSON.parse(localStorage.getItem(TRANSLATIONS_KEY) || JSON.stringify({th:{}, en:{}, lo:{}, 'zh-CN':{}, ja:{}, vi:{}}));

// ================= HELPERS =================
function escapeHtml(s){return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function saveMenuToLocal(arr){localStorage.setItem(STORAGE_KEY, JSON.stringify(arr, null, 2));}
function loadMenuFromLocal(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];}catch(e){return []}}

// ================= STATE =================
let menu = loadMenuFromLocal();
let editingIndex = null;

// DOM refs
const menuListWrap = document.getElementById('menuListWrap');
const nameInput = document.getElementById('menuName');
const descInput = document.getElementById('menuDesc');
const priceInput = document.getElementById('menuPrice');
const codeInput = document.getElementById('menuCode');
const categorySelect = document.getElementById('menuCategory');
const fileInput = document.getElementById('menuImageFile');
const imagePreview = document.getElementById('imagePreview');
const menuPreview = document.getElementById('menuPreview');
const translationsDump = document.getElementById('translationsDump');
const generatedKeys = document.getElementById('generatedKeys');

// init
updatePinDisplay(); render(); dumpTranslations();

// ================ IMAGE UPLOAD ================
let currentImageData = '';
fileInput.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        currentImageData = reader.result; // dataURL
        imagePreview.innerHTML = `<img src="${currentImageData}" style="max-width:160px;border-radius:8px;">`;
    };
    reader.readAsDataURL(f);
});

document.getElementById('btnRemoveImage').addEventListener('click', ()=>{
    currentImageData = '';
    fileInput.value = '';
    imagePreview.innerHTML = '';
});

// ================ FORM ACTIONS ================
document.getElementById('addBtn').addEventListener('click', ()=>{
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = priceInput.value.trim();
    const code = codeInput.value.trim();
    const category = categorySelect.value;
    if(!name || !price){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤'); return; }

    const item = { name, desc, price: Number(price), code, category, image: currentImageData || '' };
    if(editingIndex !== null){
        menu[editingIndex] = item; editingIndex = null;
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } else {
        menu.push(item);
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
    }
    saveMenuToLocal(menu); render(); clearForm();
});

document.getElementById('clearBtn').addEventListener('click', clearForm);

document.getElementById('saveLocal').addEventListener('click', ()=>{ saveMenuToLocal(menu); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });

document.getElementById('downloadJson').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(menu, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='menu.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// import JSON
document.getElementById('uploadJson').addEventListener('click', ()=> document.getElementById('fileIn').click());
document.getElementById('fileIn').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; const r = new FileReader();
    r.onload = ()=>{
        try{ const data = JSON.parse(r.result); if(!Array.isArray(data)) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô array'); if(!confirm('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return; menu = data; saveMenuToLocal(menu); render(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
        catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '+err.message); }
    };
    r.readAsText(f);
});

// clear all
document.getElementById('clearAll').addEventListener('click', ()=>{
    if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ menu=[]; saveMenuToLocal(menu); render(); alert('‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß'); }
});

// ================ RENDER LIST ================
function render(){
    menuListWrap.innerHTML='';
    if(!menu.length){ menuListWrap.innerHTML = '<p class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</p>'; menuPreview.innerHTML='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; return; }
    menu.forEach((it, idx)=>{
        const el = document.createElement('div'); el.className='menu-item';
        el.innerHTML = `
            ${it.image?`<img src='${it.image}' alt='${escapeHtml(it.name)}'>`:''}
            <div class='menu-meta'>
                <strong>${escapeHtml(it.name)}</strong>
                <div class='small'>${escapeHtml(it.desc)}</div>
                <div style='margin-top:6px'><span style='font-weight:800;color:var(--accent2)'>${Number(it.price)} ‡∏ø</span> ‚Ä¢ <span class='small'>${escapeHtml(it.category)}</span></div>
            </div>
            <div style='display:flex;flex-direction:column;gap:8px'>
                <button data-edit='${idx}' class='btn-ghost'>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button data-delete='${idx}' class='btn-danger'>üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
        `;
        menuListWrap.appendChild(el);
    });

    // attach event listeners
    menuListWrap.querySelectorAll('[data-edit]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const idx = Number(e.currentTarget.getAttribute('data-edit'));
        loadToForm(idx);
    }));
    menuListWrap.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click', (e)=>{
        const idx = Number(e.currentTarget.getAttribute('data-delete'));
        if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ menu.splice(idx,1); saveMenuToLocal(menu); render(); }
    }));

    // preview first item
    const first = menu[0]; menuPreview.innerHTML = `
        <div class='menu-item' style='border-radius:10px;padding:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))'>
            ${first.image?`<img src='${first.image}' alt='${escapeHtml(first.name)}'>`:''}
            <div style='margin-left:10px'>
                <strong>${escapeHtml(first.name)}</strong>
                <div class='small'>${escapeHtml(first.desc)}</div>
                <div style='margin-top:8px;color:var(--accent2);font-weight:800'>${Number(first.price)} ‡∏ö‡∏≤‡∏ó</div>
            </div>
        </div>
    `;
}

function loadToForm(idx){ const it = menu[idx]; editingIndex = idx; nameInput.value = it.name; descInput.value = it.desc; priceInput.value = it.price; codeInput.value = it.code||''; categorySelect.value = it.category||'main'; currentImageData = it.image||''; imagePreview.innerHTML = currentImageData?`<img src='${currentImageData}' style='max-width:160px;border-radius:8px;'>` : ''; }

function clearForm(){ editingIndex = null; nameInput.value=''; descInput.value=''; priceInput.value=''; codeInput.value=''; categorySelect.value='main'; currentImageData=''; imagePreview.innerHTML=''; fileInput.value=''; }

// ================ TRANSLATION GENERATOR ================
async function translateText(text, targetLang){ if(!text) return ''; try{ const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=th&tl=${encodeURIComponent(targetLang)}&dt=t&q=${encodeURIComponent(text)}`); const data = await res.json(); return data[0][0][0]; } catch(e){ console.warn('translate failed', e); return `[${targetLang}] ${text}`; } }

document.getElementById('generateMenuBtn').addEventListener('click', async ()=>{
    const nameTh = document.getElementById('menuNameTh').value.trim();
    const descTh = document.getElementById('menuDescTh').value.trim();
    const priceTh = document.getElementById('menuPriceTh').value.trim();
    if(!nameTh || !descTh || !priceTh){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏£‡∏≤‡∏Ñ‡∏≤'); return; }

    generatedKeys.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•...';
    const langs = Array.from(document.querySelectorAll('.lang:checked')).map(i=>i.value);
    // compute next index
    const existingKeys = Object.keys(translations.th||{}).filter(k=>k.startsWith('menu.item')&&k.endsWith('.name'));
    const nextIndex = existingKeys.length + 1; const keyBase = `menu.item${nextIndex}`;

    const results = {};
    // always include th
    results['th'] = { [`${keyBase}.name`]: nameTh, [`${keyBase}.desc`]: descTh, [`${keyBase}.price`]: `${priceTh} ‡∏ö‡∏≤‡∏ó` };

    // translate concurrently
    const promises = langs.filter(l=>l!=='th').map(async (l)=>{
        const name = await translateText(nameTh, l);
        const desc = await translateText(descTh, l);
        let priceStr = priceTh;
        if(l==='en') priceStr = `${priceTh} Baht`;
        else if(l==='lo') priceStr = `${priceTh} ‡∫Å‡∫µ‡∫ö`;
        else if(l==='zh-CN') priceStr = `${priceTh} Ê≥∞Èì¢`;
        else if(l==='ja') priceStr = `${priceTh} „Éê„Éº„ÉÑ`;
        else if(l==='vi') priceStr = `${priceTh} Baht`;
        results[l] = { [`${keyBase}.name`]: name, [`${keyBase}.desc`]: desc, [`${keyBase}.price`]: priceStr };
    });
    await Promise.all(promises);

    // insert into in-memory translations (but not auto-overwrite existing keys)
    Object.keys(results).forEach(lang=>{ translations[lang] = translations[lang] || {}; Object.assign(translations[lang], results[lang]); });
    // show
    generatedKeys.textContent = JSON.stringify(results, null, 2);
    dumpTranslations();
    alert('‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå translations.js ‡πÑ‡∏î‡πâ');
});

// copy json
document.getElementById('copyJsonBtn').addEventListener('click', ()=>{
    const t = generatedKeys.textContent; if(!t.trim()){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
    navigator.clipboard.writeText(t).then(()=>{ alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });
});

// insert to translations local (already done in generate) ‚Äî but provide explicit button
document.getElementById('insertToTranslations').addEventListener('click', ()=>{ localStorage.setItem(TRANSLATIONS_KEY, JSON.stringify(translations, null, 2)); dumpTranslations(); alert('‡πÅ‡∏ó‡∏£‡∏Å translations ‡∏•‡∏á localStorage ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });

// download translations.js
document.getElementById('downloadTranslations').addEventListener('click', ()=>{
    const content = `// translations.js - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Admin Tool\nwindow.TRANSLATIONS = ${JSON.stringify(translations, null, 2)};`;
    const blob = new Blob([content], {type:'application/javascript'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='translations.js'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

function dumpTranslations(){ translationsDump.textContent = JSON.stringify(translations, null, 2); }

// ================ EXCEL EXPORT ================
document.getElementById('downloadExcel').addEventListener('click', ()=>{
    if(!menu.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }
    const ws_data = [ ['name','desc','price','category','code','image_dataURL'] ];
    menu.forEach(it=>{ ws_data.push([it.name, it.desc, it.price, it.category || '', it.code || '', it.image || '']); });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Menu');
    XLSX.writeFile(wb, 'menu.xlsx');
});

// ================ PIN / LOGIN ================
function updatePinDisplay(){ document.getElementById('currentPin').value = localStorage.getItem(PIN_KEY) || '----'; }

document.getElementById('savePinBtn').addEventListener('click', ()=>{
    const v = document.getElementById('newPin').value.trim(); if(!v || v.length<4){ alert('PIN ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏´‡∏•‡∏±‡∏Å'); return; }
    localStorage.setItem(PIN_KEY, v); updatePinDisplay(); alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); document.getElementById('newPin').value='';
});

document.getElementById('btnChangePin').addEventListener('click', ()=>{
    const cur = prompt('‡πÉ‡∏™‡πà PIN ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô:'); if(cur===null) return; if(cur !== localStorage.getItem(PIN_KEY)){ alert('PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
    const np = prompt('‡πÉ‡∏™‡πà PIN ‡πÉ‡∏´‡∏°‡πà (4 ‡∏´‡∏•‡∏±‡∏Å):'); if(np && np.length>=4){ localStorage.setItem(PIN_KEY, np); updatePinDisplay(); alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } else alert('PIN ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
});

function handleLogin(){ const v = (document.getElementById('pin').value||'').trim(); if(v === localStorage.getItem(PIN_KEY)){ document.getElementById('loginWrap').style.display='none'; document.getElementById('adminUI').style.display='block'; render(); alert('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö!'); } else alert('PIN ‡∏ú‡∏¥‡∏î'); }

document.getElementById('btnLogin').addEventListener('click', handleLogin);
document.getElementById('pin').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleLogin(); });
document.getElementById('btnUseDemo').addEventListener('click', ()=>{ if(confirm('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ document.getElementById('loginWrap').style.display='none'; document.getElementById('adminUI').style.display='block'; render(); } });

// ================ DOWNLOAD translations on unload (optional) ================
window.addEventListener('beforeunload', ()=>{ localStorage.setItem(TRANSLATIONS_KEY, JSON.stringify(translations, null, 2)); });

// ================ utility to show persisted translations on load ================
// load persisted translations if exist
(function(){ const saved = localStorage.getItem(TRANSLATIONS_KEY); if(saved){ translations = JSON.parse(saved); dumpTranslations(); } })();

</script>
</body>
</html>
